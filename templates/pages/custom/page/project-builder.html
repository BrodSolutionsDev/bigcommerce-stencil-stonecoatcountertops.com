{{#partial "page"}}
<div id="wrapper">
  <!-- 0) Choose project -->
  {{> components/custom/project-builder/choose-project }}

  <div id="calculator" class="flex-col" style="display: none">
    {{> components/custom/project-builder/layout/header }}
    <div id="calculator-body">
      <!-- 1) Size -->
      {{> components/custom/project-builder/countertop/step1 }}
      <!-- 2) Project type -->
      {{> components/custom/project-builder/countertop/step2 }}
      <!-- 3) Surface -->
      {{> components/custom/project-builder/countertop/step3 }}
      <!-- 4) Finish -->
      {{> components/custom/project-builder/countertop/step4 }}
      <!-- 5) Results -->
      {{> components/custom/project-builder/countertop/step5 }}
    </div>
    <button id="mobile-next" class="mobile-next continue calculator-button">Next</button>
  </div>
</div>
<div style="display: flex; justify-content: flex-end;">
  <button class="button button--primary" id="startOver">Start Over</button>
</div>
<p class="pb-disclaimer"><strong>Disclaimer</strong>:
  Stone Coat Countertops offers no warranty, either expressed or implied, as to the reliability of the information
  contained herein and they assume no liability for loss or damage associated with use of these calculators.</p>

{{{region name="project_builder_above_body"}}} {{{ body }}} {{{region name="project_builder_below_body"}}}

<script>
  const intersectionObserver = new IntersectionObserver(entries => {
    // If intersectionRatio is 0, the target is out of view
    // and we do not need to do anything.
    for (const entry of entries) {
      if (entry.intersectionRatio <= 0) continue;
      const target = entry.target;
      const step = target.id.split('-')[2];

      openOrCloseModal(step);
    }
  });
  // start observing
  document.querySelectorAll('.open-modal-text').forEach(element => {
    intersectionObserver.observe(element);
  });

  function openOrCloseModal(step) {
    // dynamically select the elements based on the current step
    const closeModalbutton = document.getElementById(`close-choose-${step}-modal`);
    const chooseModal = document.getElementById(`help-choose-${step}-modal`);
    const openModalButton = document.getElementById(`help-choose-${step}`);

    openModalButton?.addEventListener('click', function () {
      chooseModal.setAttribute('open', null);
    });

    closeModalbutton?.addEventListener('click', function () {
      chooseModal.removeAttribute('open');
    });
  }

  // get the chosen system from the dropdown
  const systemSelect = document.getElementById('system');
  let systemChoice = Array.from(document.getElementById('system').children).filter(
    child => child.value === document.getElementById('system').value
  )[0];

  // localStorage interaction functions
  function pbUpdateStorage(key, value) {
    const projectRequirements = JSON.parse(localStorage.getItem('project-requirements'));
    projectRequirements[key] = value;
    localStorage.setItem('project-requirements', JSON.stringify(projectRequirements));
  }
  function pbGetStorageByKey(key) {
    const projectRequirements = JSON.parse(localStorage.getItem('project-requirements'));
    return projectRequirements[key];
  }
  function pbGetStorage() {
    return JSON.parse(localStorage.getItem('project-requirements'));
  }
  function setCurrentStep(step) {
    localStorage.setItem("currentStep", JSON.stringify({ step }))
  }
  function getCurrentStep() {
    return JSON.parse(localStorage.getItem("currentStep")).step;
  }
  window.getCurrentStep = getCurrentStep;

  // sections
  const calculator = document.getElementById('calculator');
  const amount = document.getElementById('amount');
  const state = document.getElementById('stateAndUndercoat');
  const finish = document.getElementById('colorAndFinish');
  const results = document.getElementById('results');
  const projectSelection = document.getElementById('choose-project');
  const helpModal = document.getElementById('help-calculate-modal');
  const projectChoices = document.getElementById('project-choices');
  // options
  const countertopProject = document.getElementById('countertop-project');
  // buttons
  const previous = document.getElementById('previous');
  const closeCalculateModal = document.getElementById('close-calculate-modal');
  const calculate = document.getElementById('calculate-amount-button');
  const helpCalculate = document.getElementById('help-calculate');
  // inputs
  const totalSqFt = document.getElementById('total-sqft');

  let projectRequirements;
  // starting requirements
  if (localStorage.getItem("startOver") === null || localStorage.getItem("startOver") === "true") {
    projectRequirements = {
      sqft: 0,
      project_type: {
        name: null,
        sku: null
      },
      undercoat_color: {
        name: null,
        sku: null
      },
      project_system: {
        name: systemChoice.value,
        sku: systemChoice.dataset.sku
      },
      primary_color: {
        name: null,
        sku: null
      },
      secondary_color: {
        name: null,
        sku: null
      },
      accent_color: {
        name: null,
        sku: null
      },
      project_finish: {
        name: null,
        sku: null
      },
      gallon_kits: {
        name: 'Epoxy Gallon Kits',
        sku: null
      }
    };
  } else {
    projectRequirements = JSON.parse(localStorage.getItem("project-requirements"));
  }

  helpCalculate.addEventListener('click', function () {
    helpModal.setAttribute('open', null);
  });

  closeCalculateModal.addEventListener('click', function () {
    helpModal.removeAttribute('open');
  });

  localStorage.setItem('project-requirements', JSON.stringify(projectRequirements));

  function updateCalculatorHeaderSteps(step) {
    // grab the step indicator from the project builder header
    const stepIndicator = document.querySelector(`[data-step="${step}"]`);
    if (!stepIndicator) return;
    let currentStepIndicator = stepIndicator;
    const steps = [];
    while (true) {
      // if there is no previous step, break out of the loop
      if (!currentStepIndicator.previousElementSibling) break;
      // push the last step to the steps array when the "next" button is pressed
      steps.push(currentStepIndicator.previousElementSibling);
      // update the currentStepIndicator to run the while loop again
      currentStepIndicator = currentStepIndicator.previousElementSibling;
    }
    // when the step is updated, remove all the complete classes and update the innerHTML of the step indicator
    document.querySelectorAll('.complete').forEach((step, index) => {
      step.classList.remove('complete');
      step.innerHTML = index + 1;
    });
    // for every step in the steps array, update it's classList to include "complete" and change it's inneerHTML to a checkmark
    steps.forEach(step => {
      step.classList.add('complete');
      step.innerHTML = '&check;';
    });
    // remove all current-step classes
    document.querySelectorAll('.current-step').forEach(step => step.classList.remove('current-step'));
    // set the current step class on the current step
    stepIndicator.classList.add('current-step');
  }

  // the current step in the calculator
  let currentStep = 0;
  setCurrentStep(currentStep);

  // handle which step to show in the calculator
  function calculatorProgress(step = 0) {
    let currentStep = step;
    // when the next button is hit, run the updateCalculatorHeaderSteps function
    updateCalculatorHeaderSteps(step);
    // dynamically show each section based on the current step
    switch (currentStep) {
      case 0:
        projectSelection.style.display = 'flex';
        calculator.style.display = 'none';
        document.getElementById('tempColorChoice').style.display = 'none';
        amount.style.display = 'none';
        state.style.display = 'none';
        finish.style.display = 'none';
        results.style.display = 'none';
        document.querySelector('.mobile-next').style.display = 'none';
        break;
      case 1:
        projectSelection.style.display = 'none';
        calculator.style.display = 'flex';
        document.getElementById('tempColorChoice').style.display = 'none';
        amount.style.display = 'flex';
        state.style.display = 'none';
        finish.style.display = 'none';
        results.style.display = 'none';
        document.querySelector('.mobile-next').style.display = 'block';
        break;
      case 2:
        projectSelection.style.display = 'none';
        calculator.style.display = 'flex';
        document.getElementById('tempColorChoice').style.display = 'flex';
        amount.style.display = 'none';
        state.style.display = 'none';
        finish.style.display = 'none';
        results.style.display = 'none';
        document.querySelector('.mobile-next').style.display = 'block';
        break;
      case 3:
        projectSelection.style.display = 'none';
        calculator.style.display = 'flex';
        document.getElementById('tempColorChoice').style.display = 'none';
        amount.style.display = 'none';
        state.style.display = 'flex';
        finish.style.display = 'none';
        results.style.display = 'none';
        document.querySelector('.mobile-next').style.display = 'block';
        break;
      case 4:
        projectSelection.style.display = 'none';
        calculator.style.display = 'flex';
        document.getElementById('tempColorChoice').style.display = 'none';
        amount.style.display = 'none';
        state.style.display = 'none';
        finish.style.display = 'flex';
        results.style.display = 'none';
        document.querySelector('.mobile-next').style.display = 'block';
        break;
      case 5:
        projectSelection.style.display = 'none';
        calculator.style.display = 'flex';
        document.getElementById('tempColorChoice').style.display = 'none';
        amount.style.display = 'none';
        state.style.display = 'none';
        finish.style.display = 'none';
        results.style.display = 'flex';
        document.querySelector('.mobile-next').style.display = 'none';
        break;
      default:
        console.log("you're not supposed to be here!");
    }
  }

  // go back a step
  previous.addEventListener('click', function (e) {
    e.preventDefault();

    // if the step is already at 0, do nothing
    if (currentStep <= 0) return;

    // reduce the currentStep by 1 step
    currentStep--;
    // update the calculator progress
    calculatorProgress(currentStep);
    setCurrentStep(currentStep);
  });

  // go to next step
  document.getElementById('calculator').addEventListener('click', function (e) {
    e.preventDefault();
    if (!e.target.closest('.continue')) return;
    currentStep++;
    calculatorProgress(currentStep);
    setCurrentStep(currentStep)
  });

  // ========================================
  // 0. Listen for project selection
  // ========================================
  projectChoices.addEventListener('click', function (e) {
    e.preventDefault();

    const project = e.target.closest('.start-project');
    if (!project) return;

    document.getElementById('project-type').innerHTML = `<p>Project: ${project.dataset.project}</p>`;
    // set the step to 1 since a project has been chosen
    currentStep = 1;
    // // update the calculator progress
    calculatorProgress(currentStep);
    setCurrentStep(currentStep)
  });

  // from w3 schools
  function openShape(evt, cityName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName('tabcontent');
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = 'none';
    }
    tablinks = document.getElementsByClassName('tablinks');
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(' active', '');
    }
    document.getElementById(cityName).style.display = 'flex';
    evt.currentTarget.className += ' active';
  }
</script>

<script>
  async function getProductDetails(sku) {
    if (!sku) return;

    const res = await fetch('/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: 'Bearer {{settings.storefront_api.token}}'
      },
      body: JSON.stringify({
        query: `
        {
          site {
            product(sku: "${sku}") {
              entityId
              name
              path
              sku
              defaultImage {
                tiny_thumbnail: url(width: 80)
              }
              prices {
                price {
                  value
                }
                salePrice {
                  value
                }
              }
              inventory {
                isInStock
              }
              variants(first: 150) {
                edges {
                  node {
                    prices {
                      basePrice {
                        value
                      }
                    }
                    sku
                    entityId
                    isPurchasable
                    options {
                      edges {
                        node {
                          displayName
                          entityId
                          values {
                            edges {
                              node {
                                entityId
                                label
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }`
      })
    });

    const { data } = await res.json();
    const { product } = data.site;

    return {
      id: product.entityId,
      image: product.defaultImage.tiny_thumbnail,
      in_stock: product.inventory.isInStock,
      url: product.path,
      sku: product.sku,
      name: product.name,
      default_price: product.prices.price.value,
      sale_price: product.prices.salePrice?.value,
      variants: product.variants.edges.map(({ node }) => {
        return {
          sku: node.sku,
          variant_id: node.entityId,
          purchasable: node.isPurchasable,
          price: node.prices.basePrice.value,
          options: node.options.edges?.map(({ node }) => {
            return {
              name: node.displayName,
              option_id: node.entityId,
              values: node.values.edges.map(({ node }) => {
                return {
                  value_id: node.entityId,
                  label: node.label
                };
              })
            };
          })
        };
      })
    };
  }
</script>

<script>
  function addToCart(cartArr) {
    // grab the last item in the cart
    const item = cartArr[cartArr.length - 1];
    // create a new formData object
    const formData = new FormData();
    formData.append('action', 'add');
    // set the product ID
    formData.append('product_id', item.product_id);
    // set the quantity
    formData.append('qty[]', item.qty);
    // if the product has a variant...
    if (item.variant) {
      // set the attribute to the option id and the value to the variant value id
      formData.append(`attribute[${item.variant.option_id}]`, item.variant.value_id);
    }
    // remove the last item from the array
    cartArr.pop();
    // add the item to the cart
    window.stencilUtils.api.cart.itemAdd(formData, (err, response) => {
      let errMessage = err || response.data.error;
      if (errMessage) return console.log("ERROR: ", errMessage)
      // if the cart array is still full...
      if (cartArr.length > 0) {
        document.querySelector('.cart-quantity').innerText =
          Number(document.querySelector('.cart-quantity').innerText) + Number(item.qty);
        // set the innerText of the add to cart button to show it's still working
        document.getElementById('atc').innerText = 'Adding to Cart';
        document.getElementById('atc').disabled = true;
        // run the function again
        setTimeout(() => {
          console.log("waiting half a second...")
        }, 500);
        return addToCart(cartArr);
      } else {
        document.querySelector('.cart-quantity').innerText =
          Number(document.querySelector('.cart-quantity').innerText) + 1;
        // if the cart array is empty, update the add to cart text to show it's finished
        document.getElementById('atc').innerText = 'Added to Cart!';
        // disable the button to prevent users from clicking it multiple times
        document.getElementById('atc').disabled = true;
      }
    });
  }

  async function createPowderDropdowns() {
    // fetch all the metallic powder (id: 116) variants
    const res = await fetch('/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
        Authorization: 'Bearer {{settings.storefront_api.token}}'
      },
      body: JSON.stringify({
        query: `
                    query getStockValues {
                        site {
                            metallicPowder: product(entityId: 116) {
                                name
                                variants(first: 150) {
                                    edges {
                                        variant: node {
                                            sku
                                            entityId
                                            isPurchasable
                                            inventory {
                                                isInStock
                                            }
                                            defaultImage {
                                                url(width: 50, height: 50)
                                            }
                                            options {
                                                edges {
                                                    option: node {
                                                        values {
                                                            edges {
                                                                node {
                                                                    label
                                                                    entityId
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                `
      })
    });

    const data = await res.json();
    // grab only the variants that are purchasable and in stock
    const variants = inStockAndPurchasableVariants(data.data.site.metallicPowder.variants.edges);
    // grab the productView-options div to append the elements to
    const options = document.getElementById('custom-color-dropdowns');
    // create a select element for each color selection
    const selectPrimary = document.createElement('select');
    const selectSecondary = document.createElement('select');
    // set the id and class of each color select element
    selectPrimary.id = 'primary-color';
    // selectPrimary.className = 'form-select form-select--small';
    selectSecondary.id = 'secondary-color';
    // selectSecondary.className = 'form-select form-select--small';
    // append each in stock and purchasable variant option to each color select element
    createOptions(selectPrimary, variants);
    createOptions(selectSecondary, variants);
    // create a div element to hold each label + color select element
    const divPrimary = createInput(selectPrimary, 'primary-color');
    const divSecondary = createInput(selectSecondary, 'secondary-color');
    // add each color select div element to the DOM
    // must append secondary -> primary because each one inserts at the very top of productView-options
    options.insertBefore(divSecondary, options.firstChild);
    options.insertBefore(divPrimary, options.firstChild);

    // if the primary color changes
    document.getElementById('primary-color').addEventListener('change', function (e) {
      // set the variant image to be visible and set the dropdown border to #333
      document.getElementById('primary-color-image').style.visibility = 'visible';
      document.getElementById('primary-color').style.border = '1px solid #333';
      document.getElementById('primary-color').previousElementSibling.firstElementChild.style.color = '#333';

      for (let child of e.target.children) {
        if (child.value === e.target.value) {
          document.getElementById('primary-color-image').src = child.dataset.image;

          if (child.value === '') {
            document.getElementById('primary-color-image').style.visibility = 'hidden';
          }
          continue;
        }
      }

      let primaryChoice = Array.from(e.target.children).filter(child => child.value === e.target.value)[0];

      pbUpdateStorage('primary_color', {
        name: primaryChoice.value,
        sku: primaryChoice.dataset.sku
      });
    });

    // if the secondary color changes
    document.getElementById('secondary-color').addEventListener('change', function (e) {
      // set the variant image to be visible and set the dropdown border to #333
      document.getElementById('secondary-color-image').style.visibility = 'visible';
      document.getElementById('secondary-color').style.border = '1px solid #333';
      document.getElementById('secondary-color').previousElementSibling.firstElementChild.style.color = '#333';

      for (let child of e.target.children) {
        if (child.value === e.target.value) {
          document.getElementById('secondary-color-image').src = child.dataset.image;

          if (child.value === '') {
            document.getElementById('secondary-color-image').style.visibility = 'hidden';
          }
          continue;
        }
      }

      let secondaryChoice = Array.from(e.target.children).filter(child => child.value === e.target.value)[0];

      pbUpdateStorage('secondary_color', {
        name: secondaryChoice.value,
        sku: secondaryChoice.dataset.sku
      });
    });
  }

  async function createDyeDropdown() {
    // fetch all the metallic powder (id: 116) variants
    const res = await fetch('/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
        Authorization: 'Bearer {{settings.storefront_api.token}}'
      },
      body: JSON.stringify({
        query: `
                    query getStockValues {
                        site {
                            liquidDye: product(entityId: 142) {
                                name
                                variants(first: 150) {
                                    edges {
                                        variant: node {
                                            sku
                                            entityId
                                            isPurchasable
                                            inventory {
                                                isInStock
                                            }
                                            defaultImage {
                                                url(width: 50, height: 50)
                                            }
                                            options {
                                                edges {
                                                    option: node {
                                                        values {
                                                            edges {
                                                                node {
                                                                    label
                                                                    entityId
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                `
      })
    });

    const data = await res.json();
    // grab only the variants that are purchasable and in stock
    const variants = inStockAndPurchasableVariants(data.data.site.liquidDye.variants.edges);
    // grab the productView-options div to append the elements to
    const options = document.getElementById('custom-color-dropdowns');
    // create a select element for the accent dye
    const selectAccent = document.createElement('select');
    // set the id of the dye select element
    selectAccent.id = 'accent-color';
    // append each in stock and purchasable variant option to the dye select element
    createOptions(selectAccent, variants);
    // create a div element to hold the dye label + color select element
    const divAccent = createInput(selectAccent, 'accent-color');
    // add dye select div element to the DOM after the secondary color dropdown
    options.appendChild(divAccent);

    // if the accent color changes
    document.getElementById('accent-color').addEventListener('change', function (e) {
      // set the variant image to be visible and set the dropdown border to #333
      document.getElementById('accent-color-image').style.visibility = 'visible';
      document.getElementById('accent-color').style.border = '1px solid #333';
      document.getElementById('accent-color').previousElementSibling.firstElementChild.style.color = '#333';

      for (let child of e.target.children) {
        if (child.value === e.target.value) {
          document.getElementById('accent-color-image').src = child.dataset.image;

          if (child.value === '') {
            document.getElementById('accent-color-image').style.visibility = 'hidden';
          }
          continue;
        }
      }

      let accentChoice = Array.from(e.target.children).filter(child => child.value === e.target.value)[0];

      pbUpdateStorage('accent_color', {
        name: accentChoice.value,
        sku: accentChoice.dataset.sku
      });
    });
  }

  function inStockAndPurchasableVariants(allVariants) {
    // filter out any variant that isn't in stock or purchasable
    const variants = allVariants.filter(edge => edge.variant.isPurchasable && edge.variant.inventory.isInStock);
    // only use skus in this list for the dropdowns
    const skuList = [
      // metallic powder
      'AL31005-15G',
      'AL31015-15G',
      '767311985296',
      '767311985302',
      'AL31001-15G',
      'AL31043-15G',
      'AL31021-15G',
      '728370322095',
      'AL31057-15G',
      'AL31049-15G',
      'AL31009-15G',
      'AL31055-15G',
      'AL31053-15G',
      'AL31013-15G',
      'AL31051-15G',
      // liquid dye
      'AL30001',
      'AL30101',
      'AL30601',
      'AL31601',
      'AL31701',
      'AL31501',
      'AL31401',
      'AL30401',
      'AL30501',
      'AL30701',
      'AL30901',
      'AL30201',
      'AL30301',
      'AL30801'
    ];
    // filter out the valid variants from the variants above to return only the allowed colors
    const validVariants = variants.filter(edge => skuList.includes(edge.variant.sku));
    // return only the variant id and the variant name
    return validVariants.map(edge => ({
      variant_id: edge.variant.entityId,
      sku: edge.variant.sku,
      image: edge.variant.defaultImage.url,
      option_name: edge.variant.options.edges[0].option.values.edges[0].node.label,
      option_id: edge.variant.options.edges[0].option.values.edges[0].node.entityId
    }));
  }

  function createOptions(select, allVariants) {
    // grab the variant_id and variant_name of each variant
    for (let { sku, variant_id, option_name, option_id, image } of allVariants) {
      // create a new option element to append to the select element
      const option = document.createElement('option');
      // set the option value as the variant_id
      option.value = option_name;
      option.dataset.sku = sku;
      // add the image as data-image to display on the option label
      option.dataset.image = image;
      // set the option text to the option_name
      option.innerText = option_name;
      // append the option to the select element
      select.appendChild(option);
    }

    const option = document.createElement('option');
    option.value = '';
    option.innerText = 'Choose color';
    select.insertBefore(option, select.children[0]);
    select.value = '';
  }

  function createInput(select, label) {
    // create a div to hold the label and select element
    const div = document.createElement('div');
    // set the class name of the div
    div.className = 'flex-row';
    div.style.gap = '20px';
    div.style.justifyContent = 'left';
    // set the label "for" value and inner HTML
    div.innerHTML = `<p style="display: flex; gap: 10px; align-items: center; font-size: 16px; margin-bottom: 12px;"><label for="${label}" style="text-transform: capitalize; text-align: left; margin-bottom: 0; width: 130px;">${label.replace(
      '-',
      ' '
    )}</label><img id="${label}-image" style="width: 50px; height: 50px; aspect-ratio: 1/1; visibility: hidden" src="" width="50" height="50"></p>`;
    // add the select element to the div
    div.appendChild(select);
    // return the div to be appended to the DOM
    return div;
  }

  // check how many times the system selection dropdown has been interacted with
  let systemDropdownChanged = 0;

  document.getElementById('system').addEventListener('change', function () {
    if (this.value !== 'Custom') {
      document.getElementById('custom-color-selection').style.display = 'none';
    } else {
      document.getElementById('custom-color-selection').style.display = 'block';
      // increase the interaction count by 1
      systemDropdownChanged++;
      // only load this function one time on the first interaction
      // otherwise, the function keeps adding custom dropdowns for every time the dropdown is clicked
      if (systemDropdownChanged === 1) {
        createPowderDropdowns();
        createDyeDropdown();
      }
    }
  });

  // listen for any "next step" button to be clicked and stop any playing iframes
  document.querySelectorAll(".continue").forEach(button => {
    button.addEventListener("click", function () {
      document.querySelectorAll('.pb-youtube-video').forEach(iframe => {
        const src = iframe.src;
        iframe.src = src;
      });
    });
  });

  // listen for any "start project" button to be clicked and stop all playing iframes
  document.querySelectorAll(".start-project").forEach(button => {
    button.addEventListener("click", function () {
      document.querySelectorAll('.pb-youtube-video').forEach(iframe => {
        const src = iframe.src;
        iframe.src = src;
      });
    });
  });

  // listen for the "previous" button to be clicked and stop all playing iframes
  document.getElementById("previous").addEventListener("click", function () {
    document.querySelectorAll('.pb-youtube-video').forEach(iframe => {
      const src = iframe.src;
      iframe.src = src;
    });
  });

  if (localStorage.getItem("startOver") === "false") {
    setCurrentStep(5);
    calculatorProgress(5);
    currentStep = 5;
    document.getElementById("startOver").setAttribute("style", "display: block !important");
  } else {
    document.getElementById("startOver").setAttribute("style", "display: none !important");
  }

  document.getElementById("startOver").addEventListener("click", function (e) {
    e.preventDefault();

    localStorage.setItem("startOver", "true");
    window.location.reload();
  });
</script>

<!-- EACH STEP CODE -->

<script>
  (function () {
    // ================================================
    // STEP 1 - PROJECT CALCULATOR
    // ================================================
    const totalSqFtInput = document.getElementById('total-sqft');
    const addBacksplashInput = document.getElementById("addBacksplash");
    // surfaceValues and cutoutValues are required to validate that both inputs are filled out on 'help calculate'
    const surfaceValues = {};
    const cutoutValues = {};

    // listen for sqft input change, update storage on change
    totalSqFtInput.addEventListener('change', function (e) {
      // uncheck the backsplash input if manually changing the sq footage
      document.getElementById("addBacksplash").checked = false;
      pbUpdateStorage('sqft', Number(e.target.value));
    });
    // listen for 'amount-next' (next button for step 1) to be clicked and update storage on click
    document.getElementById("amount-next").addEventListener("click", function () {
      pbUpdateStorage('sqft', Number(totalSqFtInput.value));
    });


    // add the value of only the edited surface inputs
    document.getElementById('modal-calculations').addEventListener('change', function (e) {
      // only grab the target if it has this class
      const input = e.target.closest('.countertop-surface-dimensions');
      if (!input) return;
      if (Number(input.value) === 0) return;
      // destructure the section name and dimension name from the id of the input
      const [section, dimension] = input.id.split('-');
      // if no section exists in the surface values input, add an empty object
      if (!surfaceValues[section]) surfaceValues[section] = {};
      // set the value to the value of the input
      surfaceValues[section][dimension] = {
        value: Number(input.value),
        element: input
      };
    });

    // add the value of only the edited cutout inputs
    document.getElementById('modal-calculations').addEventListener('change', function (e) {
      // only grab the target if it has this class
      const input = e.target.closest('.countertop-cutout-dimensions');
      if (!input) return;
      // destructure the section name and dimension name from the id of the input
      // second comma is required since the id has two dashes
      const [section, , dimension] = input.id.split('-');
      // if no section exists in the surface values input, add an empty object
      if (!cutoutValues[section]) cutoutValues[section] = {};
      // set the value to the value of the input
      cutoutValues[section][dimension] = {
        value: Number(input.value),
        element: input
      };
    });

    function validateInputsReturnTotals(event, valuesObj) {
      let tempTotal = 0;
      for (const section of Object.values(valuesObj)) {
        if (Object.values(section).length < 2) {
          const invalidElement = Object.values(section)[0].element || Object.values(section)[1].element;
          invalidElement.closest('.help-calculate-inputs').style.background = 'rgba(255, 0, 0, .25)';
          document.getElementById('calculate-help-inputs').style.display = 'block';
          event.stopImmediatePropagation();
          return;
        } else {
          const invalidElement = Object.values(section)[0].element || Object.values(section)[1].element;
          invalidElement.closest('.help-calculate-inputs').style.background = 'transparent';
          document.getElementById('calculate-help-inputs').style.display = 'none';
        }
        // add the length * width of the sections to the total
        tempTotal += calculateTotalSqFt(section);
      }
      return tempTotal;
    }

    const calculateTotalSqFt = arr => Object.values(arr).reduce((acc, cur) => acc.value * cur.value);

    document.getElementById('calculate-amount-button').addEventListener('click', function (e) {
      // uncheck the backsplash button if updating calculations - prevents add 10% bugs
      document.getElementById("addBacksplash").checked = false;
      // set the total to zero to reset the value every time
      // loop over the surface value sections
      let totalSurface = validateInputsReturnTotals(e, surfaceValues);
      let totalCutout = validateInputsReturnTotals(e, cutoutValues);

      if (totalSurface === undefined || totalCutout === undefined) return;

      if (totalCutout > totalSurface) {
        e.stopImmediatePropagation();
        document.getElementById('calculate-help-amounts').style.display = 'block';
        return;
      } else {
        document.getElementById('calculate-help-amounts').style.display = 'none';
        // set the total sq ft input in step 1 to the value, fixed to two decimal places
        totalSqFtInput.dataset.total = ((totalSurface - totalCutout) / 144).toFixed(2);
        totalSqFtInput.value = totalSqFtInput.dataset.total;
        pbUpdateStorage('sqft', Number(totalSqFtInput.dataset.total));
        document.getElementById("help-calculate-modal").removeAttribute("open");
      }
    });

    document.getElementById("addBacksplash-section").addEventListener("click", function (e) {
      // flip the checkbox to checked/unchecked if clicked
      addBacksplashInput.checked = !addBacksplashInput.checked;
      // grab the sqft from storage (sqft is updated on calculate or input change)
      const sqft = JSON.parse(localStorage.getItem("project-requirements"))['sqft'];

      if (addBacksplashInput.checked) {
        // add 10%
        totalSqFtInput.value = (Number(totalSqFtInput.value) + Number(sqft * .1)).toFixed(2);
      } else {
        // remove 10%
        totalSqFtInput.value = (Number(totalSqFtInput.value) - Number(sqft * .1)).toFixed(2);
      }
    });

    // ================================================
    // STEP 2 - COUNTERTOP COLOR FINISH
    // ================================================
    const projectSystem = document.querySelector("[name='project_system']");
    const kits = {
      'Baltic Brown': {
        80: { sku: 'SCBBE4GAL' },
        40: { sku: 'SCBBE2GAL' },
        20: { sku: 'SCBBE1GAL' },
        10: { sku: 'SCBBEHALF' }
      },
      'Black Exotic Marble': {
        80: { sku: 'SCCBLKMARBLE4' },
        40: { sku: 'SCCBLKMARBLE2' },
        20: { sku: 'SCCBLKMARBLE1' },
        10: { sku: 'SCCBLKMARBLEHALF' }
      },
      'Black Galaxy': {
        80: { sku: 'SCBGE4GAL' },
        40: { sku: 'SCBGE2GAL' },
        20: { sku: 'SCBGE1GAL' },
        10: { sku: 'SCBGEHALF' }
      },
      'Black Marble': {
        80: { sku: 'SCBME4GAL' },
        40: { sku: 'SCBME2GAL' },
        20: { sku: 'SCBME1GAL' },
        10: { sku: 'SCBMEHALF' }
      },
      'Blue Fractured Granite': {
        80: { sku: 'SCBFG4GAL' },
        40: { sku: 'SCBFG2GAL' },
        20: { sku: 'SCBFG1GAL' },
        10: { sku: 'SCBFGHALF' }
      },
      'Caramel Marble': {
        80: { sku: 'SCCARMELKIT4' },
        40: { sku: 'SCCARMELKIT2' },
        20: { sku: 'SCCARMELKIT1' },
        10: { sku: 'SCCARMELKITHALF' }
      },
      'Carrara Marble Exotic': {
        80: { sku: 'SCCME4GAL' },
        40: { sku: 'SCCME2GAL' },
        20: { sku: 'SCCME1GAL' },
        10: { sku: 'SCCMEHALF' }
      },
      'Natural Earth Tones': {
        80: { sku: 'SCSPEARTHTONE4' },
        40: { sku: 'SCSPEARTHTONE2' },
        20: { sku: 'SCSPEARTHTONE1' },
        10: { sku: 'SCSPEARTHTON1/2' }
      },
      'White Exotic Marble': {
        80: { sku: 'SCCWHTMARBLE4GA' },
        40: { sku: 'SCCWHTMARBLE2GA' },
        20: { sku: 'SCCWHTMARBLE1GA' },
        10: { sku: 'SCCWHTMARBLEHAL' }
      }
    };

    // get the initial kit choice (before user changes) in case they don't select a different kit
    // grab the kits after the user clicks "next" on the previous step (otherwise, the sqft is set to 1)
    document.getElementById("amount-next").addEventListener("click", () => getRequiredKits(kits));

    // update the requiredKits on user selection
    projectSystem.addEventListener('change', () => getRequiredKits(kits));

    function getRequiredKits(kits) {
      // An array of kits needed to fulfill the project
      const kitsRequired = [];
      // grab the sqft from localStorage to grab the correct kit size
      const sqft = JSON.parse(localStorage.getItem('project-requirements'))['sqft'];
      // get the choice from the kit dropdown (before listening for change in case user doesn't change kit)
      let choice = Array.from(document.getElementById('system').children).filter(
        child => child.value === document.getElementById('system').value
      )[0];
      if (choice.value !== 'Custom') {
        // grab the required kit from the kits object based on the choice
        let kit = kits[choice.innerText];

        if (sqft <= 10) kitsRequired.push(kit['10']);
        else if (sqft <= 20) kitsRequired.push(kit['20']);
        else if (sqft <= 40) kitsRequired.push(kit['40']);
        else if (sqft <= 80) kitsRequired.push(kit['80']);
        else {
          // set an iterations to prevent endless loops
          let iterations = 0;
          // initially set remainingSqft to the total sqft required
          let remainingSqft = sqft;
          while (true) {
            // if the loop iterates more than 20 times, break out of the loop
            if (iterations >= 20) break;
            // if the remainingSqft is lessthan or equalto zero, break
            if (remainingSqft <= 0) break;
            // sort the kit variants from greatest to least (arrays always sort lowest to highest by default)
            const sortedKit = Object.entries(kit).sort((a, b) => b[0] - a[0]);
            // loop over the kit variants
            for (const [coverage, variant] of sortedKit) {
              // subtract the coverage of the kit from the remaining sqft
              const leftover = Number(remainingSqft) - Number(coverage);
              // if it has a leftover
              if (leftover >= 0) {
                // push the variant to the kits required
                kitsRequired.push(variant);
                // set the remainingSwft to the leftover for the next iteration
                remainingSqft = leftover;
              }
            }
            // increment the iterations
            iterations++;
          }

          if (remainingSqft > 0) {
            kitsRequired.push(kit['10'])
          }
        }
        // update local storage
        pbUpdateStorage('project_system', {
          name: choice.value,
          sku: kitsRequired
        });

        document.getElementById("temp1-next").style.position = "relative";
        document.getElementById("temp1-next").style.bottom = 'unset';
      } else {
        // update local storage
        pbUpdateStorage('project_system', {
          name: 'Custom',
          sku: ''
        });

        document.getElementById("temp1-next").style.position = "sticky";
        document.getElementById("temp1-next").style.bottom = 0;
      }
    }

    // ================================================
    // STEP 3 - PROJECT SURFACE
    // ================================================
    const projectSurface = document.querySelector("[name='project_surface']");
    const projectUndercoat = document.querySelector("[name='undercoat_color']");

    // check for the height of step 3 when the previous steps "next" button is hit
    document.getElementById("temp1-next").addEventListener("click", function () {
      // wait for 100ms (1/10 of a second). If fired immediately, the window will not have loaded to verify the height
      setTimeout(() => {
        if (document.getElementById("stateAndUndercoat").scrollHeight > 700) {
          document.getElementById("state-next").style.position = "sticky";
          document.getElementById("state-next").style.bottom = 0;
        } else {
          document.getElementById("state-next").style.position = "relative";
          document.getElementById("state-next").style.bottom = "unset";
        }
      }, 100);

      if (JSON.parse(localStorage.getItem('project-requirements'))['project_system'].name !== 'Custom') {
        document.getElementById('project-undercoat').style.display = 'none';
        document.getElementById('undercoat-help-text').style.display = 'none';

        let surfaceChoice = Array.from(projectSurface.children).filter(
          child => child.value === projectSurface.value
        )[0];

        let undercoatChoice = Array.from(projectUndercoat.children).filter(
          child => child.value === projectUndercoat.value
        )[0];

        pbUpdateStorage("project_type", {
          name: surfaceChoice.value,
          sku: surfaceChoice.dataset.sku
        });

        projectSurface.addEventListener("change", function (e) {
          surfaceChoice = Array.from(projectSurface.children).filter(
            child => child.value === projectSurface.value
          )[0];

          pbUpdateStorage("project_type", {
            name: surfaceChoice.value,
            sku: surfaceChoice.dataset.sku
          });
        });
      } else {
        document.getElementById('project-undercoat').style.display = 'block';
        document.getElementById('undercoat-help-text').style.display = 'block';

        let surfaceChoice = Array.from(projectSurface.children).filter(
          child => child.value === projectSurface.value
        )[0];

        pbUpdateStorage("project_type", {
          name: surfaceChoice.value,
          sku: surfaceChoice.dataset.sku
        });

        let undercoatChoice = Array.from(projectUndercoat.children).filter(
          child => child.value === projectUndercoat.value
        )[0];

        pbUpdateStorage("undercoat_color", {
          name: undercoatChoice.value,
          sku: undercoatChoice.dataset.sku
        });

        projectSurface.addEventListener('change', function () {
          surfaceChoice = Array.from(projectSurface.children).filter(
            child => child.value === projectSurface.value
          )[0];

          pbUpdateStorage("project_type", {
            name: surfaceChoice.value,
            sku: surfaceChoice.dataset.sku
          });
        })

        projectUndercoat.addEventListener('change', function () {
          undercoatChoice = Array.from(projectUndercoat.children).filter(
            child => child.value === projectUndercoat.value
          )[0];

          pbUpdateStorage("undercoat_color", {
            name: undercoatChoice.value,
            sku: undercoatChoice.dataset.sku
          });
        });
      }
    });
    // ================================================
    // STEP 4 - TOP COAT OPTIONS
    // ================================================
    const projectFinish = document.querySelector("[name='project_finish']");

    // grab the current choice for the finish dropdown BEFORE a user makes a selection
    let finishChoice = Array.from(projectFinish.children).filter(child => child.value === projectFinish.value)[0];
    pbUpdateStorage('project_finish', {
      name: finishChoice.value,
      sku: finishChoice.dataset.sku
    });
    // grab the user selected finish dropdown option
    projectFinish.addEventListener('change', function (e) {
      finishChoice = Array.from(projectFinish.children).filter(child => child.value === projectFinish.value)[0];

      pbUpdateStorage('project_finish', {
        name: finishChoice.value,
        sku: finishChoice.dataset.sku
      });
    });

    // ================================================
    // STEP 5 - RESULTS
    // ================================================
    // set the initial addToCartArr to an empty array
    let addToCartArr = [];

    window.addEventListener("load", function () {
      if (currentStep === 5) {
        step5();
      }
    })

    // run the following code only AFTER the previous step's "next" button is clicked
    document.getElementById("finish-next").addEventListener("click", () => step5());
    // ---------------------------------------------------
    // ADD THE ITEMS TO CART ON BUTTON CLICK
    // ---------------------------------------------------
    // fire off the addToCart function when the add to cart button is clicked
    document.getElementById('atc').addEventListener('click', function (e) {
      addToCart(addToCartArr);
    });
    // ---------------------------------------------------
    // SEND THE DATA TO MY.POLYTEK IF SAVE FOR LATER IS CLICKED
    // ---------------------------------------------------
    // Assuming you have a button with id 'sfl'
    /*
    document.getElementById('sfl').addEventListener('click', function () {
      // present a modal with Email and Name fields

      // Your project requirements data
      const projectRequirements = {
        // @ BRAD:  what else needs to be included?
        // Cart Object?
        // Customer ID?
        // Referral URL?
        // For now, the API will accept all of the body data as a single object, so please include all necessary data here
        store_hash: 'fy21dwtsxg',
        project_data: JSON.parse(localStorage.getItem('project-requirements')),
        cart_array: addToCartArr
      };

      // Post data to the endpoint
      fetch('https://my.polytek.com/api/calculation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(projectRequirements)
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('sfl').innerText = "Saved!"
          console.log(data)
        })
        .catch(error => {
          document.getElementById('sfl').innerText = "An error occurred"
          console.error('Error:', error);
        });
    });
    */
    const step5 = async function () {
      // user made it to the final step, store data until user manually starts over
      localStorage.setItem("startOver", "false");
      document.getElementById("startOver").setAttribute("style", "display: block !important");
      // clear the cart list to append updated values every time this is ran
      document.getElementById('results-cart-list').innerHTML = null;
      // set the add to cart text to Add to Cart every time this function is ran
      document.getElementById('atc').innerText = 'Add to Cart';
      // set the add to cart button to "not disabled" every time this function is ran
      document.getElementById('atc').disabled = false;
      // grab the requirements from the localStorage object
      const requirements = JSON.parse(localStorage.getItem('project-requirements'));
      // ---------------------------------------------------
      // UPDATE PROJECT REQUIREMENTS ON LEFT SIDE OF STEP 5
      // ---------------------------------------------------
      // loop over the requirements to append to the DOM (project requirements list)
      for (const [key, value] of Object.entries(requirements)) {
        if (key !== 'sqft') {
          // if the key does not equal sqft
          // destructure the name and sku from the object entry
          const { name, sku } = value;
          // if there is no value, skip this iteration
          if (value === '' || key === 'gallon_kits') continue;
          // display the selected requirement next to the name in the requirement list (ex: Project Surface: Existing Countertop)
          document.getElementById(`${key}-results`).innerHTML = name;
        } else {
          // if the key DOES equal sqft, set the number as the name in the requirment list (ex: Total Square Footage: 22 sqft)
          document.getElementById(`${key}-results`).innerHTML = value;
        }
      }
      // Show/hide the custom color selections from the requirement list in the DOM if custom colors were/were not chosen
      if (requirements['project_system'].name !== 'Custom') {
        document.querySelectorAll('.custom-color-results').forEach(color => (color.style.display = 'none'));
        document.querySelector('.undercoat-color-results').style.display = 'none';
      } else {
        document.querySelectorAll('.custom-color-results').forEach(color => (color.style.display = 'block'));
        document.querySelector('.undercoat-color-results').style.display = 'block';
      }
      // grab the arary of skus from the project system, add up all the coverage based on sku, display the results on the coverage-results element
      document.getElementById("coverage-results").innerText = Array.from(requirements['project_system'].sku).reduce((acc, curr) => {
        // get the name of the project system used (example: Baltic Brown)
        const kit = kits[JSON.parse(localStorage.getItem('project-requirements'))['project_system'].name];
        // get all the variants from the kit
        const kitArr = Object.entries(kit);
        // filter out the kit variant based on the sku from the project_system sku array
        const variant = kitArr.filter(([coverage, value]) => value.sku === curr.sku)[0];
        // add the coverage to the accumulator 
        return acc + Number(variant[0])
      }, 0);
      // ---------------------------------------------------
      // GET DETAILS PER PRODUCT VIA GRAPHQL
      // ---------------------------------------------------
      const detailsArr = [];
      for (const [key, value] of Object.entries(requirements)) {
        if (key === 'undercoat_color' && value.name === 'Grey') {
          continue;
          // if the sku is an array of skus (project_system)
        } else if (Array.isArray(value.sku)) {
          value.sku.forEach(v => detailsArr.push(getProductDetails(v.sku)));
          continue;
        }
        detailsArr.push(getProductDetails(value.sku));
      }
      // push the undercoat_color requirements to the details array
      const undercoatColor = requirements['undercoat_color'];
      if (undercoatColor.name) {
        // if grey is the chosen color...
        if (undercoatColor.sku.includes('__')) {
          detailsArr.push(getProductDetails(undercoatColor.sku.split('__')[0]));
          detailsArr.push(getProductDetails(undercoatColor.sku.split('__')[1]));
        } else {
          // otherwise, add the chosen color (black or white)
          detailsArr.push(getProductDetails(undercoatColor.sku));
        }
      }
      // ---------------------------------------------------
      // IF CUSTOM SYSTEM, GET EPOXY GALLON KITS SKU(s)
      // ---------------------------------------------------
      if (requirements['project_system'].name === 'Custom') {
        // epoxy gallon kit skus and coverage
        const gallonKit = {
          'Epoxy Gallon Kits': {
            80: { sku: 'SCC4GAL' },
            40: { sku: 'SCCE2GK' },
            20: { sku: 'SCCE1GK' },
            10: { sku: 'SCCE64OZK' }
          }
        }

        const gallonKitsRequired = [];
        // grab the required kit from the kits object based on the choice
        const kit = gallonKit['Epoxy Gallon Kits'];
        if (Number(requirements['sqft']) <= 10) gallonKitsRequired.push(kit['10']);
        else if (Number(requirements['sqft']) <= 20) gallonKitsRequired.push(kit['20']);
        else if (Number(requirements['sqft']) <= 40) gallonKitsRequired.push(kit['40']);
        else if (Number(requirements['sqft']) <= 80) gallonKitsRequired.push(kit['80']);
        else {
          // set an iterations to prevent endless loops
          let iterations = 0;
          // initially set remainingSqft to the total sqft required
          let remainingSqft = Number(requirements['sqft']);
          while (true) {
            // if the loop iterates more than 20 times, break out of the loop
            if (iterations >= 20) break;
            // if the remainingSqft is lessthan or equalto zero, break
            if (remainingSqft <= 0) break;
            // sort the kit variants from greatest to least (arrays always sort lowest to highest by default)
            const sortedKit = Object.entries(kit).sort((a, b) => b[0] - a[0]);
            // loop over the kit variants
            for (const [coverage, variant] of sortedKit) {
              // subtract the coverage of the kit from the remaining sqft
              const leftover = Number(remainingSqft) - Number(coverage);
              // if it has a leftover
              if (leftover >= 0) {
                // push the variant to the kits required
                gallonKitsRequired.push(variant);
                // set the remainingSwft to the leftover for the next iteration
                remainingSqft = leftover;
              }
            }
            // increment the iterations
            iterations++;
          }

          if (remainingSqft > 0) {
            gallonKitsRequired.push(kit['10'])
          }
        }
        // update requirements with the epoxy gallon kits required skus
        requirements['gallon_kits'].sku = gallonKitsRequired;
        // get the epoxy gallon kits GraphQL data and push each product detail to the detailsArr
        gallonKitsRequired.forEach(kit => detailsArr.push(getProductDetails(kit.sku)))

        // ---------------------------------------------------
        // UPDATE THE PROJECT TOTAL COVERAGE IN PROJECT REQUIREMENTS
        // ---------------------------------------------------
        // grab the arary of skus from the project system, add up all the coverage based on sku, display the results on the coverage-results element
        document.getElementById("coverage-results").innerText = Array.from(requirements['gallon_kits'].sku).reduce((acc, curr) => {
          // get the name of the project system used (example: Baltic Brown)
          const kit = gallonKit['Epoxy Gallon Kits'];
          // get all the variants from the kit
          const kitArr = Object.entries(kit);
          // filter out the kit variant based on the sku from the project_system sku array
          const variant = kitArr.filter(([coverage, value]) => value.sku === curr.sku)[0];
          // add the coverage to the accumulator 
          return acc + Number(variant[0])
        }, 0);
      }
      // ---------------------------------------------------
      // GET THE GRAPHQL RESULTS AS USABLE OBJECTS
      // ---------------------------------------------------
      // getProductDetails returns a promise, return an array of settled promises
      const settled = await Promise.allSettled(detailsArr);
      // filter out the results with values from the settled array
      const results = settled.filter(result => result.value);
      // ---------------------------------------------------
      // GET THE SKU, VARIANT/PRODUCT NAME, AND OBJECT KEY (KEY) FROM THE
      // LOCALSTORAGE REQUIREMENTS OBJECT AS AN ARRAY
      // ---------------------------------------------------
      // return all the skus from the requirements
      const reqValues = getValuesFromRequirements(Object.entries(requirements));

      function getValuesFromRequirements(values) {
        // store the skus in a temp array to return
        const skus = [];
        // loop over the requirement results
        for (const [key, value] of values) {
          // if the value is the sq ft requirement, continue in the loop
          if (typeof value === 'number') continue;
          // destructure the name and sku from the requirement
          const { name, sku } = value;
          // if either name or sku is null, continue in the loop
          if (name === null || sku === null || sku === undefined) continue;
          if (sku.includes('__')) {
            // grey undercoat
            skus.push({
              sku: sku.split('__')[0],
              name: name,
              key: key
            });
            skus.push({
              sku: sku.split('__')[1],
              name: name,
              key: key
            });
            // project_system or epoxy gallon kit sku array
          } else if (Array.isArray(sku)) {
            sku.forEach(s => skus.push({
              sku: s.sku,
              name: name,
              key: key
            }))
          } else {
            // everything else
            skus.push({
              sku: sku,
              name: name,
              key: key
            });
          }
        }
        return skus;
      }
      // ---------------------------------------------------
      // MAP THE REQVALUES TO EASY TO USE DATA TO CREATE "CART" CARDS
      // ---------------------------------------------------
      // create an object to loop over for creating "cart cards"
      const cards = {};

      reqValues.forEach(v => {
        // if the cards object does not have an entry for the value name
        if (!cards[v.name]) cards[v.name] = {};
        // if the cards object does not have an entry for the sku name inside the value name object
        if (!cards[v.name][v.sku]) cards[v.name][v.sku] = {};
        // if the sku inside the value name object does not have a quantity
        if (!cards[v.name][v.sku].qty) cards[v.name][v.sku].qty = 1;
        // otherwise, incremenent that sku's quantity by 1
        else cards[v.name][v.sku].qty = ++cards[v.name][v.sku].qty
      });

      // ---------------------------------------------------
      // CREATE THE "CART" CARDS ON THE RIGHT SIDE OF STEP 5
      // ---------------------------------------------------
      // reset the addToCartArr before creating new cards
      addToCartArr = [];
      for (const [kit, data] of Object.entries(cards)) {
        if (kit === "Custom") continue;
        for (let [sku, qty] of Object.entries(data)) {
          if (!sku) continue;
          if (requirements['primary_color'].sku === sku) qty.qty *= 6;
          if (requirements['secondary_color'].sku === sku) qty.qty *= 3;

          const { value } = results.filter(result => result.value.sku === sku)[0];
          const variant = value.variants.filter(variant => variant.sku === value.sku)[0];
          // create a div to add to the cart list
          const cartItem = document.createElement('div');
          cartItem.className = 'results-cart-item';
          cartItem.dataset.price = value.sale_price ? value.sale_price : value.default_price;
          // set the innerHTML of the div + add option line if there is a variant option
          cartItem.innerHTML = `
            <img class="results-cart-item__image" src="${value.image}" />
            <h4 class="results-cart-item__title"><a href="${value.url}">${value.name.toUpperCase()}</a></h4>
            ${variant.options.length
              ? `<p class="results-cart-item__option">${variant.options[0].name}: ${variant.options[0].values[0].label}</p>`
              : ''
            }
            <p class="results-cart-item__quantity">Quantity: ${qty.qty}</p>
            `;
          // append the div to the cart list
          document.getElementById('results-cart-list').appendChild(cartItem);
          // add the data to the cart array
          if (variant.options.length) {
            // if the variant has options
            addToCartArr.push({
              product_id: value.id,
              variant: {
                option_id: variant.options[0].option_id,
                value_id: variant.options[0].values[0].value_id
              },
              qty: qty.qty,
              price: value.sale_price ? value.sale_price : value.default_price
            });
          } else {
            // if the variant does NOT have options
            addToCartArr.push({
              product_id: value.id,
              variant: null,
              qty: qty.qty,
              price: value.sale_price ? value.sale_price : value.default_price
            });
          }
        }
      }
      // ---------------------------------------------------
      // UPDATE THE TOTAL PRICE BELOW CARDS
      // ---------------------------------------------------
      // loop over each total using the data-price attribute
      const total = addToCartArr.reduce((acc, cur) => acc + Number(cur.price * cur.qty), 0)
      // set the total in the DOM
      document.getElementById('kit-total').innerHTML = `Kit Total: $${total.toFixed(2)}`;
    };

    document.getElementById("mobile-next").addEventListener("click", function () {
      if (currentStep === 1) {
        pbUpdateStorage('sqft', Number(totalSqFtInput.value));
        getRequiredKits(kits);
      }
      if (currentStep === 2) {
        if (JSON.parse(localStorage.getItem('project-requirements'))['project_system'].name !== 'Custom') {
          document.getElementById('project-undercoat').style.display = 'none';
          document.getElementById('undercoat-help-text').style.display = 'none';

          let surfaceChoice = Array.from(projectSurface.children).filter(
            child => child.value === projectSurface.value
          )[0];

          let undercoatChoice = Array.from(projectUndercoat.children).filter(
            child => child.value === projectUndercoat.value
          )[0];

          pbUpdateStorage("project_type", {
            name: surfaceChoice.value,
            sku: surfaceChoice.dataset.sku
          });

          projectSurface.addEventListener("change", function (e) {
            surfaceChoice = Array.from(projectSurface.children).filter(
              child => child.value === projectSurface.value
            )[0];

            pbUpdateStorage("project_type", {
              name: surfaceChoice.value,
              sku: surfaceChoice.dataset.sku
            });
          });
        } else {
          document.getElementById('project-undercoat').style.display = 'block';
          document.getElementById('undercoat-help-text').style.display = 'block';

          let surfaceChoice = Array.from(projectSurface.children).filter(
            child => child.value === projectSurface.value
          )[0];

          pbUpdateStorage("project_type", {
            name: surfaceChoice.value,
            sku: surfaceChoice.dataset.sku
          });

          let undercoatChoice = Array.from(projectUndercoat.children).filter(
            child => child.value === projectUndercoat.value
          )[0];

          pbUpdateStorage("undercoat_color", {
            name: undercoatChoice.value,
            sku: undercoatChoice.dataset.sku
          });

          projectSurface.addEventListener('change', function () {
            surfaceChoice = Array.from(projectSurface.children).filter(
              child => child.value === projectSurface.value
            )[0];

            pbUpdateStorage("project_type", {
              name: surfaceChoice.value,
              sku: surfaceChoice.dataset.sku
            });
          })

          projectUndercoat.addEventListener('change', function () {
            undercoatChoice = Array.from(projectUndercoat.children).filter(
              child => child.value === projectUndercoat.value
            )[0];

            pbUpdateStorage("undercoat_color", {
              name: undercoatChoice.value,
              sku: undercoatChoice.dataset.sku
            });
          });
        }
      }
      if (currentStep === 4) step5();
    })
  })();
</script>

{{/partial}} {{> layout/base}}