<div id="tempColorChoice" class="flex-col step" style="display: none">
  <h2 class="calculator-heading">Countertop Color Finish</h2>
  <div class="step-wrapper flex-row">
    <div class="step-wrapper__left">
      <div id="project-system" class="flex-col">
        <div id="project-state" class="flex-col step-choice">
          <h3>What is your color system</h3>
          <span class="project-selection">
            <select name="project_system" id="system">
              <option value="Baltic Brown" data-sku="SCBBE">Baltic Brown</option>
              <!-- sku won't work, doesn't match others -->
              <option value="Black Exotic Marble" data-sku="SCCBLKMARBLE">Black Exotic Marble</option>
              <option value="Black Galaxy" data-sku="SCBGE">Black Galaxy</option>
              <option value="Black Marble" data-sku="SCBME">Black Marble</option>
              <option value="Blue Fractured Granite" data-sku="SCBFG">Blue Fractured Granite</option>
              <option value="Caramel Marble" data-sku="SCCARMELKIT">Caramel Marble</option>
              <option value="Carrara Marble Exotic" data-sku="SCCME">Carrara Marble Exotic</option>
              <!-- No sku -->
              <!-- <option value="Carrara Marble Hand Meld" data-sku="SCCME">Carrara Marble Hand Meld</option> -->
              <!-- No sku -->
              <!-- <option value="Green Exotic Marble" data-sku="SCCME">Green Exotic Marble</option> -->
              <!-- sku won't work, doesn't match others -->
              <option value="Natural Earth Tones" data-sku="SCSPEARTHTON">Natural Earth Tones</option>
              <!-- No sku -->
              <!-- <option value="Soapstone" data-sku="SCCBLKMARBLE">Soapstone</option> -->
              <!-- sku won't work, doesn't match others -->
              <option value="White Exotic Marble" data-sku="SCCWHTMARBLE">White Exotic Marble</option>
              <option value="Custom">Custom (select your own colors)</option>
            </select>
          </span>
        </div>

        <div id="custom-color-selection" class="flex-col step-choice" style="display: none">
          <h3>Select your colors</h3>
          <div id="custom-color-dropdowns"></div>
        </div>
        <div class="step-help-text">
          <h4>Help me choose</h4>
          <p>
            Select from any pre-built epoxy countertop color finish above. If you don't find one you want, select CUSTOM
            (select your own colors) to create a countertop finish that's uniquely yours.
          </p>
          <p>Each pre-built Epoxy Countertop Finish Kit comes with:</p>
          <ul>
            <li>Stone Coat Countertop Epoxy or Art Coat Epoxy</li>
            <li>Polycolor Metallic Powders</li>
            <li>Liquid Epoxy Dye Colors</li>
            <li>Epoxy Undercoat</li>
            <li>Your choice of Top Coat Finish</li>
          </ul>
        </div>
        <button id="temp1-next" class="desktop-next continue calculator-button">Next</button>
      </div>
    </div>
    {{> components/custom/project-builder/modals/help-choose-surface }}
    <div class="step-wrapper__right">
      <div class="color-system-grid">
        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Baltic-Brown.png' }}" alt="Baltic Brown" />
          <p>Baltic Brown</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Black-Exotic-Marble.png' }}" alt="Black Exotic Marble" />
          <p>Black Exotic Marble</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Black-Galaxy.png' }}" alt="Black Galaxy" />
          <p>Black Galaxy</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Black-Marble.png' }}" alt="Black Marble" />
          <p>Black Marble</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Blue-Fractured-Granite.png' }}" alt="Blue Fractured Granite" />
          <p>Blue Fractured Granite</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Caramel-Marble.png' }}" alt="Caramel Marble" />
          <p>Caramel Marble</p>
        </div>

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Carrara-Marble-Exotic.png' }}" alt="Carrara Marble Exotic" />
          <p>Carrara Marble Exotic</p>
        </div>

        <!-- <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Carrara-Marble-Hand-Meld.png' }}" alt="Carrara Marble Hand Meld" />
          <p>Carrara Marble Hand Meld</p>
        </div> -->

        <!-- <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Green-Exotic-Marble.png' }}" alt="Green Exotic Marble" />
          <p>Green Exotic Marble</p>
        </div> -->

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Natural-Earth-Tones.png' }}" alt="Natural Earth Tones" />
          <p>Natural Earth Tones</p>
        </div>

        <!-- <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/Soapstone.png' }}" alt="Soapstone" />
          <p>Soapstone</p>
        </div> -->

        <div class="color-system-grid__item">
          <img src="{{cdn '/img/color-systems/White-Exotic-Marble.png' }}" alt="White Exotic Marble" />
          <p>White Exotic Marble</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const callback = async (mutationList, observer) => {
      if (currentStep !== 2) return;
      if (document.getElementById('custom-color-selection').style.display === 'block') return;

      const kits = {
        'Baltic Brown': {
          80: { sku: 'SCBBE4GAL' },
          40: { sku: 'SCBBE2GAL' },
          20: { sku: 'SCBBE1GAL' },
          10: { sku: 'SCBBEHALF' }
        },
        'Black Exotic Marble': {
          80: { sku: 'SCCBLKMARBLE4' },
          40: { sku: 'SCCBLKMARBLE2' },
          20: { sku: 'SCCBLKMARBLE1' },
          10: { sku: 'SCCBLKMARBLEHALF' }
        },
        'Black Galaxy': {
          80: { sku: 'SCBGE4GAL' },
          40: { sku: 'SCBGE2GAL' },
          20: { sku: 'SCBGE1GAL' },
          10: { sku: 'SCBGEHALF' }
        },
        'Black Marble': {
          80: { sku: 'SCBME4GAL' },
          40: { sku: 'SCBME2GAL' },
          20: { sku: 'SCBME1GAL' },
          10: { sku: 'SCBMEHALF' }
        },
        'Blue Fractured Granite': {
          80: { sku: 'SCBFG4GAL' },
          40: { sku: 'SCBFG2GAL' },
          20: { sku: 'SCBFG1GAL' },
          10: { sku: 'SCBFGHALF' }
        },
        'Caramel Marble': {
          80: { sku: 'SCCARMELKIT4' },
          40: { sku: 'SCCARMELKIT2' },
          20: { sku: 'SCCARMELKIT1' },
          10: { sku: 'SCCARMELKITHALF' }
        },
        'Carrara Marble Exotic': {
          80: { sku: 'SCCME4GAL' },
          40: { sku: 'SCCME2GAL' },
          20: { sku: 'SCCME1GAL' },
          10: { sku: 'SCCMEHALF' }
        },
        'Natural Earth Tones': {
          80: { sku: 'SCSPEARTHTONE4' },
          40: { sku: 'SCSPEARTHTONE2' },
          20: { sku: 'SCSPEARTHTONE1' },
          10: { sku: 'SCSPEARTHTON1/2' }
        },
        'White Exotic Marble': {
          80: { sku: 'SCCWHTMARBLE4GA' },
          40: { sku: 'SCCWHTMARBLE2GA' },
          20: { sku: 'SCCWHTMARBLE1GA' },
          10: { sku: 'SCCWHTMARBLEHAL' }
        }
      };

      // grab the sqft from localStorage to grab the correct kit size
      const sqft = JSON.parse(localStorage.getItem('project-requirements'))['sqft'];
      // get the choice from the kit dropdown (before listening for change in case user doesn't change kit)
      let choice = Array.from(document.getElementById('system').children).filter(
        child => child.value === document.getElementById('system').value
      )[0];
      if (choice.value !== 'Custom') {
        // grab the required kit from the kits object based on the choice
        let kit = kits[choice.innerText];
        // set a default current variant to update on the following loop
        let currentVariant = {
          leftover: 100, // set leftover to a high number to update on the first loop iteration
          variant: {}
        };
        // loop over the entries in the kit and destructure the coverage (key) and the variant (value)
        for (const [coverage, variant] of Object.entries(kit)) {
          // subtract the required sqft from the coverage to see how much is leftover
          const leftover = Number(coverage) - Number(sqft);
          // if the leftover is smaller than the currentVariant leftover (above) and the value isn't less than zero
          if (leftover <= currentVariant.leftover && leftover >= 0) {
            // update the leftover and variant in the currentVariant object
            currentVariant.leftover = leftover;
            currentVariant.variant = variant;
          }
        }
        // update local storage
        pbUpdateStorage('project_system', {
          name: choice.value,
          sku: currentVariant.variant.sku
        });
      } else {
        // update local storage
        pbUpdateStorage('project_system', {
          name: 'Custom',
          sku: ''
        });
      }

      const projectSystem = document.querySelector("[name='project_system']");
      let projectSystemSelection = projectSystem.value;
      projectSystem.addEventListener('change', function (e) {
        projectSystemSelection = projectSystem.value;
        // get the choice from the kit dropdown
        choice = Array.from(document.getElementById('system').children).filter(
          child => child.value === document.getElementById('system').value
        )[0];
        if (choice.value !== 'Custom') {
          // grab the required kit from the kits object based on the choice
          kit = kits[choice.innerText];
          // set a default current variant to update on the following loop
          let currentVariant = {
            leftover: 100, // set leftover to a high number to update on the first loop iteration
            variant: {}
          };
          // loop over the entries in the kit and destructure the coverage (key) and the variant (value)
          for (const [coverage, variant] of Object.entries(kit)) {
            // subtract the required sqft from the coverage to see how much is leftover
            const leftover = Number(coverage) - Number(sqft);
            // if the leftover is smaller than the currentVariant leftover (above) and the value isn't less than zero
            if (leftover <= currentVariant.leftover && leftover >= 0) {
              // update the leftover and variant in the currentVariant object
              currentVariant.leftover = leftover;
              currentVariant.variant = variant;
            }
          }
          // update local storage
          pbUpdateStorage('project_system', {
            name: choice.value,
            sku: currentVariant.variant.sku
          });

          document.getElementById("temp1-next").style.position = "relative";
          document.getElementById("temp1-next").style.bottom = 'unset';
        } else {
          document.getElementById("temp1-next").style.position = "sticky";
          document.getElementById("temp1-next").style.bottom = 0;
          // update local storage
          pbUpdateStorage('project_system', {
            name: 'Custom',
            sku: ''
          });
        }
      });
    };

    // Create an observer instance linked to the callback function
    const observer = new MutationObserver(callback);

    // Start observing the target node for configured mutations
    observer.observe(document.getElementById('progress-bar'), { attributes: true, childList: true, subtree: true });
  })();
</script>